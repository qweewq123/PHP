var orderAddNew=function(e,t,a,s,r){"use strict";var n=t("#addFrom"),o=t("#realFrom"),i=t("#addressList"),d=t(t("input[name=name]").length>0?"input[name=name]":"input[name=consName]"),c=t(t("input[name=tel]").length>0?"input[name=tel]":"input[name=consPhone]"),l=t(t("input[name=address]").length>0?"input[name=address]":"input[name=detailAddress]"),p=t("#addAddress"),u=!1,m={empty:"必填",nameTypeError:"存在特殊字符或空格",telTypeError:"手机号码格式错误",selectEmpty:"请选择省份、城市、区/县、乡镇/街道",addressEmpty:"请详细填写地址信息",addressLonger:"不能多于50个字符",charError:"存在特殊字符",overPrice:"优惠价格己经超过总价格",saveError:"请保存地址",noAddress:"请选择或添加新地址"};i.on("click",".address_box:not('.disabled')",function(){n.is(":visible")&&h(),t(this).addClass("active").siblings().removeClass("active"),t("input[name=consId]").val(t(this).data("id"))});var v=function(e,a){t(".detial_address span").html((a.provinces||"")+(a.city||"")+(a.area||"")+(a.street||"")),f()},h=function(){citys.clearAll(),d.val(""),c.val(""),l.val(""),d.next().empty(),c.next().empty(),l.next().empty(),t(".detial_address span").empty(),d.removeClass("error"),c.removeClass("error"),l.removeClass("error"),t(".detial_address span").removeClass("error"),n.slideUp(400),t(".str",p).html("添加新地址").removeData()},_=function(){var e=d.val(),t=d.next();return""==e?(t.html(m.empty),d.addClass("error"),!1):/^[a-zA-Z|\d|\u0391-\uFFE5]*$/.test(e)?(t.empty(),d.removeClass("error"),!0):(t.html(m.nameTypeError),d.addClass("error"),!1)},y=function(){var e=c.val(),t=c.next();return""==e?(t.html(m.empty),c.addClass("error"),!1):11==e.length&&/^[1][34578][0-9]{9}$/.test(e)?(t.empty(),c.removeClass("error"),!0):(t.html(m.telTypeError),c.addClass("error"),!1)},f=function(){var e=l.next(),a=citys.getData().cn;return null==a.provinces||null==a.city||null==a.area||null==a.street?(e.html(m.selectEmpty),!1):(e.empty(),l.removeClass("error"),t(".detial_address span").removeClass("error"),!0)},b=function(){var e=l.val(),a=l.next();return f()?e.length<4?(a.html(m.addressEmpty),l.addClass("error"),t(".detial_address span").addClass("error"),!1):e.length>50?(a.html(m.addressLonger),l.addClass("error"),t(".detial_address span").addClass("error"),!1):/^[\u4E00-\u9FA5A-Za-z0-9_\-\,\，\.\。\(\)\（\）\s]+$/.test(e)?(a.empty(),l.removeClass("error"),t(".detial_address span").removeClass("error"),!0):(a.html(m.charError),l.addClass("error"),t(".detial_address span").addClass("error"),!1):!1},k=function(e){return e?!0:t(".address_box",i).length>=10?(C("您添加的地址数量已超过上限，请管理您的地址！"),!1):!0},C=function(e){var a=[];a.push("<div class='mask'>"),a.push("<div class='alert_box'>"),a.push("<div class='close'></div>"),a.push("<div class='content'>"+e+"</div>"),a.push("<div><div class='order_btn primary'>确定</div></div>"),a.push("</div>"),a.push("</div>"),a=t(a.join("")).appendTo("body"),a.one("click",".order_btn, .close",function(){a.remove()})},g=function(e){var t=[];return t.push('<div class="address_box active" data-id="'+e.id+'" data-provinces="'+e.province+'" data-city="'+e.city+'" data-area="'+e.area+'" data-street="'+e.street+'" data-addressdetial="'+e.consAddress+'">'),t.push('<div class="top"><span class="name">'+e.consName+'</span><span class="phone">'+e.consPhone+"</span></div>"),t.push('<div class="bottom">'+e.cn.provinces+e.cn.city+e.cn.area+e.cn.street+e.consAddress+"</div>"),t.push('<div class="control"><span class="edit">修改</span><span class="del">删除</span></div>'),t.push("</div>"),t.join("")};citys.init("#citys"),citys.on("change",v),d.on("blur",_),c.on("blur",y),l.on("blur",b),t(".order_btn.cancel",n).on("click",h),t(".order_btn.primary",n).on("click",function(){if(u)return!1;if(_()&&y()&&b()&&k(t("span",p).data("editId"))){u=!0;var e=citys.getData(),s=e.id,r=l.val(),n=t("span",p).data("editId"),o=d.val(),m=c.val(),v={province:s.provinces,city:s.city,area:s.area,street:s.street,consZipCode:s.zipCode,consAddress:e.cn.area==e.cn.street?e.cn.provinces+e.cn.city+e.cn.area+r:e.cn.provinces+e.cn.city+e.cn.area+e.cn.street+r,detailAddress:r,consId:n,consName:o,consPhone:m,formtoken:a};t.ajax({url:"/customer_address/modify_submit",type:"post",data:v,dataType:"json",success:function(a){if(u=!1,"1"==a.err)C(a.msg);else{if(v.id=a.consId,v.cn=e.cn,v.consAddress=r,v.addressdetial=r,v.provinces=s.provinces,v.isold=0,n){var d=t("span",p).data("that");d.data(v),d.find(".name").html(o),d.find(".phone").html(m),d.find(".bottom").html(e.cn.provinces+e.cn.city+e.cn.area+e.cn.street+r),d.removeClass("disabled"),d.addClass("active").siblings().removeClass("active")}else t(g(v)).prependTo(i).addClass("active").siblings().removeClass("active");t("input[name=consId]").val(a.consId),h()}},error:function(){u=!1}})}}),i.on("click",".del",function(e){e.preventDefault(),e.stopPropagation();var s=t(this).parents(".address_box"),r=t("span",p).data("editId"),o=!1;n.is(":visible")&&r==s.data("id")&&(h(),o=!0),t.ajax({url:"/customer_address/remove_submit",type:"post",dataType:"json",data:{id:s.data("id"),formtoken:a},success:function(e){"1"==e.err?C(e.msg):(o&&t("input[name=consId]").val(""),s.remove())},error:function(){C("服务器忙")}})}),i.on("click",".edit,.update_tips .order_btn",function(a){h(),a.preventDefault(),a.stopPropagation();var s=t(this).parents(".address_box"),r=s.data();r.isold?citys.setInitByChar(r.citycn,v):citys.setInit(r,v),d.val(s.find(".name").html()),c.val(s.find(".phone").html()),l.val(r.addressdetial),t(".str",p).html("修改地址"),b(),n.slideDown(400,function(){t(e).scrollTop(t(".user_address").offset().top)}),t("span",p).data({editId:s.data("id"),that:s})}),p.on("click",function(){n.slideDown(400),citys.clearAll()}),t("#orderEdit").on("click",function(){_()&&y()&&b()?t("#form_checkout").submit():t(e).scrollTop(0)});var x=t(".invoice_checkbox:not('.disabled')"),A=t(".invoice_title"),T=t(".companyItem"),E=t(".btn",A);x.on("click",function(){var e=t(this).children("input[type=checkbox]");e.prop("checked")?(t(this).removeClass("checked"),e.attr("checked",!1),A.hide()):(t(this).addClass("checked"),e.attr("checked",!0),A.show())}),E.on("click",function(){if(t(this).data("editing")){var e=t(".text input",A).val();t(this).data("editing",!1),t(this).html("修改"),T.val(e),t(".text",A).html(e)}else t(this).data("editing",!0),t(this).html("确定"),t(".text",A).html('<input type="text" class="order_input" value="'+t(".text",A).html()+'" placeholder="发票抬头..." maxlength="50">')});var w=t(".order_coupon"),I=t(".coupon_result"),P=t("#totalPrice");t(".title",w).on("click",function(){var e=t("> .coupon_type",w);e.is(":visible")?(t(this).children(".label").text("+"),e.slideUp("400")):(t(this).children(".label").text("-"),e.slideDown("400"))}),t(".buy_back > .btn",w).on("click",function(){var e=t(".coupon_content",w);e.is(":visible")?e.slideUp("400"):e.slideDown("400")});var D=function(e,a,s){var n=t("> .coupon_type",w);t.ajax({url:"/order/valid_repo_ticket",type:"POST",data:e,dataType:"json",success:function(i){1==i.err?s.html(i.msg):parseFloat(r)>parseFloat(i.msg)?(t(".num",I).html(1),t(".yuan",I).html(i.msg),t("#buyBackPrice").html(i.msg),t('<input type="hidden" value="1" name="ticket_flag" />').appendTo(o),t('<input type="hidden" value="'+e[a]+'" name="'+a+'" />').appendTo(o),"user_repo_ticket"!=a&&t('<input type="hidden" value="'+e.repo_password+'" name="repo_password" />').appendTo(o),r=(parseFloat(r)-parseFloat(i.msg)).toFixed(2),P.html(r),I.show(),s.empty(),n.remove()):s.html(m.overPrice)},error:function(){C("服务器忙")}})};t(".buy_back .coupon_content .order_btn",w).on("click",function(){var e=t("input[name=couponNo]").val(),a=t("input[name=couponPwd]").val(),r=t(".buy_back .err_msg");D({ticket_flag:1,repo_ticket:e,repo_price:s,repo_password:a},t(this).data("name"),r)}),t(".buy_back .user_had_coupon .order_btn",w).on("click",function(){var e=t(".buy_back .user_coupon").val(),a=t(".buy_back .user_had_coupon .must");D({ticket_flag:1,user_repo_ticket:e,repo_price:s},t(this).data("name"),a)});var F=function(){var a=l.next();return n.is(":visible")?(a.html(m.saveError),l.focus(),!1):""==t("input[name=consId]").val()?(t(".address_error_tip").html(m.noAddress),t(e).scrollTop(0),!1):(a.empty(),!0)};return t("#validCode").on("click",function(){var e=+new Date;t(this).attr("src","/order/get_valid_code/"+e)}),t("#submitFrom").on("click",function(){F()&&o.submit()}),{checkAddressName:_,checkAddressPhone:y,checkAddressDetail:b}}(window,$,formtoken,useCouponPrice,endPrice);